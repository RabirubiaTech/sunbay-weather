<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>Sunbay Marina Weather</title></head>
<body style="margin:0;background:#0f172a;">
<canvas id="c" width="1080" height="1080" style="display:none;"></canvas>
<script>
// YOUR GITHUB TOKEN (repo scope)
const GITHUB_TOKEN = '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';  // ← Replace with your PAT

async function run(){
  const [w,m]=await Promise.all([
    fetch("https://api.open-meteo.com/v1/forecast?latitude=18.3258&longitude=-65.6524&current=temperature_2m,apparent_temperature,weathercode,windspeed_10m,winddirection_10m&daily=temperature_2m_max,temperature_2m_min&timezone=America/Puerto_Rico&temperature_unit=fahrenheit&wind_speed_unit=mph").then(r=>r.json()),
    fetch("https://marine-api.open-meteo.com/v1/marine?latitude=18.3258&longitude=-65.6524&hourly=wave_height,wave_direction,swell_wave_height&forecast_days=3&timezone=America/Puerto_Rico").then(r=>r.json())
  ]);

  drawCard(w,m);

  c.toBlob(blob => {
    const reader = new FileReader();
    reader.onload = () => {
      const base64 = reader.result.split(',')[1];
      fetch('https://api.github.com/repos/Capt-ks/sunbay-weather/contents/sunbay_marina_forecast.png', {
        method: 'PUT',
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json'
        },
        body: JSON.stringify({
          message: `Update weather card - ${new Date().toISOString()}`,
          content: base64,
          branch: 'main'
        })
      }).then(r=>r.json()).then(console.log).catch(console.error);
    };
    reader.readAsDataURL(blob);
  }, 'image/png');
}

function drawCard(w,m){
  const cur=w.current, daily=w.daily, h=m.hourly;
  const grad=x.createLinearGradient(0,0,0,1080);
  grad.addColorStop(0,'#a5f3fc'); grad.addColorStop(1,'#ecfeff');
  x.fillStyle=grad; x.fillRect(0,0,1080,1080);

  x.textAlign='center'; x.fillStyle='#155e75';
  x.font='600 54px system-ui';
  x.fillText(new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'}),540,120);
  x.font='italic 42px system-ui'; x.fillStyle='#64748b';
  x.fillText(`Updated ${new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})} AST`,540,170);

  const L=150, R=570;
  x.textAlign='left';
  x.font='bold 58px system-ui'; x.fillStyle='#1e40af';
  x.fillText('Weather',L,280);
  x.font='900 170px system-ui'; x.fillStyle='#164e63';
  x.fillText(`${Math.round(cur.temperature_2m)}°`,L,460);
  x.font='56px system-ui'; x.fillStyle='#475569';
  x.fillText(`Feels ${Math.round(cur.apparent_temperature)}°F`,L,510);
  x.fillText(wmo(cur.weathercode),L,570);
  x.fillText(`Wind ${Math.round(cur.windspeed_10m)} mph ${compass(cur.winddirection_10m)}`,L,630);

  x.font='bold 58px system-ui'; x.fillStyle='#1e40af';
  x.fillText('Marine',R,280);
  x.font='700 120px system-ui'; x.fillStyle='#164e63';
  x.fillText(`${(h.wave_height[12]*3.28).toFixed(1)} ft`,R,460);
  x.font='56px system-ui'; x.fillStyle='#475569';
  x.fillText(`Today • ${compass(h.wave_direction[12])}`,R,510);
  x.font='64px system-ui'; x.fillStyle='#1e293b';
  x.fillText(`Tomorrow → ${(h.wave_height[36]*3.28).toFixed(1)} ft`,R,620);
  x.fillText(`Day After → ${(h.wave_height[60]*3.28).toFixed(1)} ft`,R,700);

  x.font='48px system-ui'; x.fillStyle='#1e293b';
  ['Today','Tomorrow','Day After'].forEach((d,i)=>{
    const hi=Math.round(daily.temperature_2m_max[i]);
    const lo=Math.round(daily.temperature_2m_min[i]);
    x.fillText(`${d} → ${hi}° / ${lo}°`,L,760+i*68);
  });

  x.font='italic 38px system-ui'; x.fillStyle='#64748b'; x.textAlign='center';
  x.fillText('Powered by Open-Meteo • Updated every 4 hours',540,1060);
}
function wmo(c){const m={0:"Clear sky",1:"Mostly clear",2:"Partly cloudy",3:"Cloudy",45:"Fog",51:"Light rain",53:"Rain",61:"Rain",63:"Rain",65:"Heavy rain",80:"Showers",95:"Thunderstorm"};return m[c]||"Weather";}
function compass(d){const dirs=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];return dirs[Math.round(d/22.5)%16];}

run();
</script>
</body></html>
