name: Update Sunbay Weather Card
on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          set -e
          npm install canvas node-fetch@2

      - name: Generate Weather Card
        run: |
          set -e
          cat > generate.cjs << 'EOF'
          const { createCanvas, loadImage } = require('canvas');
          const fetch = require('node-fetch');
          const fs = require('fs');

          const canvas = createCanvas(1080, 1080);
          const ctx = canvas.getContext('2d');

          const now = new Date();
          const astTime = new Date(now.getTime() - 4 * 60 * 60 * 1000);

          function safeFixed(v, d = 1) {
            return (typeof v === 'number' ? v : 0).toFixed(d);
          }

          function compass(d) {
            const dirs = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
            return dirs[Math.round(d / 22.5) % 16];
          }

          function wmo(c) {
            return {
              0:"Clear sky",1:"Mostly clear",2:"Partly cloudy",3:"Cloudy",
              45:"Fog",61:"Rain",63:"Rain",65:"Heavy rain",80:"Showers",95:"Thunderstorm"
            }[c] || "Weather";
          }

          async function run() {
            const w = await fetch(
              "https://api.open-meteo.com/v1/forecast" +
              "?latitude=18.1018&longitude=-65.6524" +
              "&current=temperature_2m,apparent_temperature,weathercode,windspeed_10m,winddirection_10m,precipitation,rain,showers" +
              "&hourly=precipitation_probability,precipitation,rain,showers" +
              "&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max" +
              "&timezone=America/Puerto_Rico&temperature_unit=fahrenheit&wind_speed_unit=mph"
            ).then(r => r.json());

            const m = await fetch(
              "https://marine-api.open-meteo.com/v1/marine" +
              "?latitude=18.1018&longitude=-65.6524" +
              "&hourly=wave_height,wave_direction,wave_period" +
              "&forecast_days=3&timezone=America/Puerto_Rico"
            ).then(r => r.json());

            const logo = await loadImage(
              "https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png"
            );

            drawCard(w, m, astTime, logo);
            fs.writeFileSync('sunbay_marina_forecast.png', canvas.toBuffer());
          }

          function drawCard(w, m, astTime, logo) {
            const cur = w.current || {};     // ✅ FIX
            const daily = w.daily || {};
            const h = m.hourly || {};

            ctx.fillStyle = '#ecfeff';
            ctx.fillRect(0, 0, 1080, 1080);

            ctx.drawImage(logo, 60, 60, 200, 200);

            const LEFT = 220;
            let y = 500;

            ctx.font = '900 70px system-ui';
            ctx.fillStyle = '#164e63';
            ctx.fillText(`${Math.round(cur.temperature_2m ?? 0)}°`, LEFT, y);

            y += 70;
            ctx.font = '30px system-ui';
            ctx.fillStyle = '#475569';
            ctx.fillText(`Feels ${Math.round(cur.apparent_temperature ?? 0)}°F`, LEFT, y);

            y += 50;
            ctx.fillStyle = '#1e293b';
            ctx.fillText(wmo(cur.weathercode), LEFT, y);

            y += 40;
            ctx.fillText(
              `Wind ${Math.round(cur.windspeed_10m ?? 0)} mph ${compass(cur.winddirection_10m ?? 0)}`,
              LEFT, y
            );
          }

          run().catch(e => { console.error(e); process.exit(1); });
          EOF

          node generate.cjs

      - name: Commit & Push
        run: |
          set -e
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add sunbay_marina_forecast.png
          git diff --staged --quiet || git commit -m "Fix current temperature source" && git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
