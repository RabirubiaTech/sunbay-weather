name: Update Sunbay Weather Card

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          set -e
          npm install canvas node-fetch@2

      - name: Generate Perfect Weather Card
        run: |
          set -e
          cat > generate.js << 'EOF'
          const { createCanvas, loadImage } = require('canvas');
          const fetch = require('node-fetch');
          const fs = require('fs');

          const canvas = createCanvas(1080, 1080);
          const ctx = canvas.getContext('2d');

          const now = new Date();
          const astTime = new Date(now.getTime() - 4*60*60*1000); // AST = UTC-4

          async function run() {
            const [w, m, logo] = await Promise.all([
              fetch("https://api.open-meteo.com/v1/forecast?latitude=18.3258&longitude=-65.6524&current=temperature_2m,apparent_temperature,weathercode,windspeed_10m,winddirection_10m,precipitation,rain,showers&hourly=precipitation_probability,precipitation,rain,showers&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max&timezone=America/Puerto_Rico&temperature_unit=fahrenheit&wind_speed_unit=mph").then(r=>r.json()),
              fetch("https://marine-api.open-meteo.com/v1/marine?latitude=18.3258&longitude=-65.6524&hourly=wave_height,wave_direction&forecast_days=3&timezone=America/Puerto_Rico").then(r=>r.json()),
              loadImage("https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png/v1/fill/w_234,h_234,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/RWRoundLogoTransp.png")
            ]);

            drawCard(w, m, astTime, logo);
            fs.writeFileSync('sunbay_marina_forecast.png', canvas.toBuffer());
            console.log('Perfect card generated!');
          }

          function drawCard(w, m, astTime, logo) {
            const cur = w.current;
            const daily = w.daily;
            const h = m.hourly;

            const grad = ctx.createLinearGradient(0,0,0,1080);
            grad.addColorStop(0, '#a5f3fc');
            grad.addColorStop(1, '#ecfeff');
            ctx.fillStyle = grad;
            ctx.fillRect(0,0,1080,1080);

            const logoSize = 200;
            const margin = 60;
            const logoX = margin;
            const logoY = margin;
            const logoCenterY = logoY + logoSize / 2;

            ctx.drawImage(logo, logoX, logoY, logoSize, logoSize);

            const textX = logoX + logoSize + 50;

            ctx.textAlign = 'left';
            ctx.textBaseline = 'middle';

            ctx.fillStyle = '#155e75';
            ctx.font = '600 52px system-ui';
            ctx.fillText(astTime.toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric'}), textX, logoCenterY - 28);

            ctx.fillStyle = '#64748b';
            ctx.font = 'italic 42px system-ui';
            ctx.fillText(`Fajardo Bay, PR • ${astTime.toLocaleTimeString('en-US', {hour:'numeric', minute:'2-digit'})} AST`, textX, logoCenterY + 28);

            const contentTop = 320;
            const LEFT = 140;
            const RIGHT = 580;

            ctx.textAlign = 'left';
            ctx.font = 'bold 52px system-ui';
            ctx.fillStyle = '#1e40af';
            ctx.fillText('Weather', LEFT, contentTop);

            ctx.font = '900 92px system-ui';
            ctx.fillStyle = '#164e63';
            ctx.fillText(`${Math.round(cur.temperature_2m)}°`, LEFT, contentTop + 160);

            ctx.font = '44px system-ui';
            ctx.fillStyle = '#475569';
            ctx.fillText(`Feels ${Math.round(cur.apparent_temperature)}°F`, LEFT, contentTop + 230);
            ctx.fillText(wmo(cur.weathercode), LEFT, contentTop + 290);
            ctx.fillText(`Wind ${Math.round(cur.windspeed_10m)} mph ${compass(cur.winddirection_10m)}`, LEFT, contentTop + 350);

            ctx.fillText(`Rain: ${cur.rain?.toFixed(2) || 0} in/hr`, LEFT, contentTop + 410);
            const precipProb = w.hourly.precipitation_probability[0];
            ctx.fillText(`Chance: ${precipProb}%`, LEFT, contentTop + 460);

            const todayRain = w.daily.precipitation_sum[0];
            const todayProb = w.daily.precipitation_probability_max[0];
            ctx.fillText(`Today: ${todayRain.toFixed(2)} in • ${todayProb}%`, LEFT, contentTop + 520);

            const tomorrowRain = w.daily.precipitation_sum[1];
            const tomorrowProb = w.daily.precipitation_probability_max[1];
            ctx.fillText(`Tomorrow: ${tomorrowRain.toFixed(2)} in • ${tomorrowProb}%`, LEFT, contentTop + 580);

            ctx.font = 'italic 40px system-ui';
            ctx.fillStyle = '#334155';

            let summary = "";
            if (todayProb >= 60) summary += "Expect rain today. ";
            else if (todayProb >= 30) summary += "Possible showers today. ";
            else summary += "Low rain chances today. ";

            if (cur.windspeed_10m >= 20) summary += "Winds remain strong.";
            else if (cur.windspeed_10m >= 12) summary += "Moderate winds.";
            else summary += "Light winds.";

            ctx.fillText(summary, LEFT, contentTop + 650);

            ctx.font = 'bold 52px system-ui';
            ctx.fillStyle = '#1e40af';
            ctx.fillText('Marine', RIGHT, contentTop);

            ctx.font = '700 92px system-ui';
            ctx.fillStyle = '#164e63';
            ctx.fillText(`${(h.wave_height[12]*3.28).toFixed(1)} ft`, RIGHT, contentTop + 160);

            ctx.font = '44px system-ui';
            ctx.fillStyle = '#475569';
            ctx.fillText(`Today • ${compass(h.wave_direction[12])}`, RIGHT, contentTop + 230);

            ctx.fillStyle = '#1e293b';
            ctx.fillText(`Tomorrow → ${(h.wave_height[36]*3.28).toFixed(1)} ft`, RIGHT, contentTop + 310);
            ctx.fillText(`Day After → ${(h.wave_height[60]*3.28).toFixed(1)} ft`, RIGHT, contentTop + 370);

            ctx.font = '44px system-ui';
            ctx.fillStyle = '#1e293b';
            ['Today','Tomorrow','Day After'].forEach((day,i) => {
              const hi = Math.round(daily.temperature_2m_max[i]);
              const lo = Math.round(daily.temperature_2m_min[i]);
              ctx.fillText(`${day} → ${hi}° / ${lo}°`, LEFT, contentTop + 460 + i*72);
            });

            ctx.textAlign = 'center';
            ctx.font = 'italic 38px system-ui';
            ctx.fillStyle = '#64748b';
            ctx.fillText('Powered by Rabirubia-API • Updated every 4 hours', 540, 1055);
          }

          function wmo(c){const m={0:"Clear sky",1:"Mostly clear",2:"Partly cloudy",3:"Cloudy",45:"Fog",51:"Light drizzle",61:"Rain",63:"Rain",65:"Heavy rain",80:"Showers",95:"Thunderstorm"};return m[c]||"Weather";}
          function compass(d){const dirs=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];return dirs[Math.round(d/22.5)%16];}

          run().catch(e=>{console.error(e);process.exit(1);});
          EOF

          node generate.js

      - name: Commit & Push
        run: |
          set -e
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add sunbay_marina_forecast.png
          git diff --staged --quiet || git commit -m "Update weather card - clean header layout" && git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
