name: Update Sunbay Weather Card

on:
  schedule:
    - cron: "0 */4 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Clean previous artifacts
        run: |
          rm -f generate.cjs
          rm -f sunbay_marina_forecast.png

      - name: Install canvas
        run: npm install canvas

      - name: Generate weather card
        run: |
          cat << 'EOF' > generate.cjs
          const { createCanvas, loadImage } = require("canvas");
          const fs = require("fs");

          const WIDTH = 1080;
          const HEIGHT = 1080;
          const canvas = createCanvas(WIDTH, HEIGHT);
          const ctx = canvas.getContext("2d");

          function compass(deg = 0) {
            const d = ["N","NE","E","SE","S","SW","W","NW"];
            return d[Math.round(deg / 45) % 8];
          }

          function wmo(code = 0) {
            const map = {
              0:"Clear",1:"Mostly Clear",2:"Partly Cloudy",3:"Overcast",
              45:"Fog",48:"Fog",
              61:"Rain",63:"Rain",65:"Rain",
              80:"Showers",81:"Showers",82:"Heavy Showers"
            };
            return map[code] || "Unknown";
          }

          function drawCard(w, astTime, logo) {
            const cur = w.current || {};

            const grad = ctx.createLinearGradient(0,0,0,HEIGHT);
            grad.addColorStop(0,"#a5f3fc");
            grad.addColorStop(1,"#ecfeff");
            ctx.fillStyle = grad;
            ctx.fillRect(0,0,WIDTH,HEIGHT);

            const margin = 60;
            ctx.drawImage(logo, margin, margin, 200, 200);

            ctx.fillStyle = "#155e75";
            ctx.font = "600 46px system-ui";
            ctx.fillText(
              astTime.toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric"}),
              320, 120
            );

            ctx.fillStyle = "#64748b";
            ctx.font = "italic 32px system-ui";
            ctx.fillText(
              `Inshore Fajardo Bay • ${astTime.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})} AST`,
              320, 170
            );

            let y = 460;
            ctx.fillStyle = "#164e63";
            ctx.font = "900 80px system-ui";
            ctx.fillText(`${Math.round(cur.temperature_2m ?? 0)}°`, 240, y);

            y += 80;
            ctx.font = "34px system-ui";
            ctx.fillStyle = "#475569";
            ctx.fillText(`Feels ${Math.round(cur.apparent_temperature ?? 0)}°F`, 240, y);

            y += 46;
            ctx.fillStyle = "#1e293b";
            ctx.fillText(wmo(cur.weathercode), 240, y);

            y += 46;
            ctx.fillText(
              `Wind ${Math.round(cur.windspeed_10m ?? 0)} mph ${compass(cur.winddirection_10m ?? 0)}`,
              240, y
            );

            ctx.textAlign = "center";
            ctx.font = "italic 28px system-ui";
            ctx.fillStyle = "#64748b";
            ctx.fillText(
              "Powered by RabirubiaTech • Updated every 4 hours",
              WIDTH / 2, HEIGHT - 40
            );
          }

          async function run() {
            const res = await fetch(
              "https://api.open-meteo.com/v1/forecast" +
              "?latitude=18.1018&longitude=-65.6524" +
              "&current=temperature_2m,apparent_temperature,weathercode,windspeed_10m,winddirection_10m" +
              "&timezone=America/Puerto_Rico&temperature_unit=fahrenheit&wind_speed_unit=mph"
            );
            const w = await res.json();

            const logo = await loadImage("./logo.png");
            drawCard(w, new Date(), logo);

            fs.writeFileSync(
              "sunbay_marina_forecast.png",
              canvas.toBuffer("image/png")
            );
          }

          run();
          EOF

      - name: Run generator
        run: node generate.cjs

      - name: Commit image
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add sunbay_marina_forecast.png
          git commit -m "Update Sunbay weather card" || echo "No changes"
          git push
