name: Update Sunbay Weather Card

on:
  schedule:
    - cron: "0 */4 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install canvas
        run: npm install canvas

      - name: Generate weather card
        run: |
          cat << 'EOF' > generate.cjs
          const { createCanvas, loadImage } = require("canvas");
          const fs = require("fs");

          const WIDTH = 1080;
          const HEIGHT = 1080;
          const canvas = createCanvas(WIDTH, HEIGHT);
          const ctx = canvas.getContext("2d");

          function compass(d=0){
            const dirs=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
            return dirs[Math.round(d/22.5)%16];
          }

          function wmo(c=0){
            const m={
              0:"Clear",1:"Mostly clear",2:"Partly cloudy",3:"Overcast",
              45:"Fog",48:"Fog",
              61:"Rain",63:"Rain",65:"Heavy rain",
              80:"Showers",81:"Showers",82:"Heavy showers"
            };
            return m[c]||"Weather";
          }

          function drawCard(w, astTime, logo) {
            const cur = w.current || {};

            const grad = ctx.createLinearGradient(0,0,0,HEIGHT);
            grad.addColorStop(0,"#a5f3fc");
            grad.addColorStop(1,"#ecfeff");
            ctx.fillStyle = grad;
            ctx.fillRect(0,0,WIDTH,HEIGHT);

            // LOGO
            if (logo) ctx.drawImage(logo, 60, 60, 200, 200);

            ctx.fillStyle="#155e75";
            ctx.font="600 46px system-ui";
            ctx.fillText(
              astTime.toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric"}),
              320,120
            );

            ctx.fillStyle="#64748b";
            ctx.font="italic 32px system-ui";
            ctx.fillText(
              `Inshore Fajardo Bay • ${astTime.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})} AST`,
              320,170
            );

            let y=460;
            ctx.font="900 80px system-ui";
            ctx.fillStyle="#164e63";
            ctx.fillText(`${Math.round(cur.temperature_2m ?? 0)}°`,240,y);

            y+=80;
            ctx.font="34px system-ui";
            ctx.fillStyle="#475569";
            ctx.fillText(`Feels ${Math.round(cur.apparent_temperature ?? 0)}°F`,240,y);

            y+=46;
            ctx.fillStyle="#1e293b";
            ctx.fillText(wmo(cur.weathercode),240,y);

            y+=46;
            ctx.fillText(
              `Wind ${Math.round(cur.windspeed_10m ?? 0)} mph ${compass(cur.winddirection_10m ?? 0)}`,
              240,y
            );

            ctx.textAlign="center";
            ctx.font="italic 28px system-ui";
            ctx.fillStyle="#64748b";
            ctx.fillText(
              "Powered by RabirubiaTech • Updated every 4 hours",
              WIDTH/2, HEIGHT-40
            );
          }

          async function run(){
            const res = await fetch(
              "https://api.open-meteo.com/v1/forecast" +
              "?latitude=18.1018&longitude=-65.6524" +
              "&current=temperature_2m,apparent_temperature,weathercode,windspeed_10m,winddirection_10m" +
              "&timezone=America/Puerto_Rico&temperature_unit=fahrenheit&wind_speed_unit=mph"
            );
            const w = await res.json();

            let logo=null;
            try {
              logo = await loadImage(
                "https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png"
              );
            } catch {
              console.warn("Logo failed to load — continuing without it");
            }

            drawCard(w, new Date(), logo);
            fs.writeFileSync("sunbay_marina_forecast.png", canvas.toBuffer("image/png"));
          }

          run().catch(e=>{console.error(e);process.exit(1);});
          EOF

          node generate.cjs

      - name: Commit & push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add sunbay_marina_forecast.png
          git commit -m "Update weather card" || echo "No changes"
          git push
