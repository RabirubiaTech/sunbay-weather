name: Update Sunbay Weather Card
on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          set -e
          npm install canvas node-fetch@2

      - name: Generate Perfect Weather Card
        run: |
          set -e
          cat > generate.cjs << 'EOF'
          const { createCanvas, loadImage } = require('canvas');
          const fetch = require('node-fetch');
          const fs = require('fs');

          const canvas = createCanvas(1080, 1080);
          const ctx = canvas.getContext('2d');

          const now = new Date();
          const astTime = new Date(now.getTime() - 4*60*60*1000);

          function safeFixed(v, d=1){ return (typeof v==="number"?v:0).toFixed(d); }

          function moonPhaseFraction(date){
            const syn=29.53058867;
            const ref=Date.UTC(2000,0,6,18,14,0);
            return ((date.getTime()-ref)/86400000/syn)%1;
          }

          function moonPhaseName(x){
            if(x<0.03)return"New Moon";
            if(x<0.22)return"Waxing Crescent";
            if(x<0.28)return"First Quarter";
            if(x<0.47)return"Waxing Gibbous";
            if(x<0.53)return"Full Moon";
            if(x<0.72)return"Waning Gibbous";
            if(x<0.78)return"Last Quarter";
            if(x<0.97)return"Waning Crescent";
            return"New Moon";
          }

          function moonIllumination(x){ return x<=0.5?x*2:(1-x)*2; }

          function wmo(c){
            return {
              0:"Clear sky",1:"Mostly clear",2:"Partly cloudy",3:"Cloudy",
              45:"Fog",61:"Rain",63:"Rain",65:"Heavy rain",80:"Showers",95:"Thunderstorm"
            }[c]||"Weather";
          }

          function compass(d){
            const dirs=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
            return dirs[Math.round(d/22.5)%16];
          }

          async function run(){
            const w=await fetch(
              "https://api.open-meteo.com/v1/forecast"+
              "?latitude=18.1018&longitude=-65.6524"+
              "&current=temperature_2m,apparent_temperature,weathercode,windspeed_10m,winddirection_10m,precipitation,rain,showers"+
              "&hourly=precipitation_probability,precipitation,rain,showers"+
              "&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max"+
              "&timezone=America/Puerto_Rico&temperature_unit=fahrenheit&wind_speed_unit=mph"
            ).then(r=>r.json());

            const m=await fetch(
              "https://marine-api.open-meteo.com/v1/marine"+
              "?latitude=18.1018&longitude=-65.6524"+
              "&hourly=wave_height,wave_direction,wave_period"+
              "&forecast_days=3&timezone=America/Puerto_Rico"
            ).then(r=>r.json());

            const midnight=new Date(astTime); midnight.setHours(0,0,0,0);
            const f=moonPhaseFraction(midnight);
            const moonPhase=moonPhaseName(f);
            const moonIllum=moonIllumination(f);
            const idx=Math.floor(f*28)%28;

            let moonIcon=null;
            try{
              moonIcon=await loadImage(
                `https://raw.githubusercontent.com/manifestinteractive/moon-phase-icons/master/png/64/moon-phase-${String(idx).padStart(2,'0')}.png`
              );
            }catch{}

            const logo=await loadImage(
              "https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png"
            );

            drawCard(w,m,astTime,logo,moonIcon,moonPhase,moonIllum);
            fs.writeFileSync("sunbay_marina_forecast.png",canvas.toBuffer());
          }

          function drawCard(w, m, astTime, logo, moonIcon, moonPhase, moonIllum) {
          const cur = w.current || {};
          const daily = w.daily || {};
          const h = m.hourly || {};
        
          // Background
          const grad = ctx.createLinearGradient(0,0,0,1080);
          grad.addColorStop(0, '#a5f3fc');
          grad.addColorStop(1, '#ecfeff');
          ctx.fillStyle = grad;
          ctx.fillRect(0,0,1080,1080);
        
          // Logo
          const logoSize = 200;
          const margin = 60;
          ctx.drawImage(logo, margin, margin, logoSize, logoSize);
        
          // Header
          const textX = margin + logoSize + 50;
          const centerY = margin + logoSize / 2;
        
          ctx.textAlign = 'left';
          ctx.textBaseline = 'middle';
        
          ctx.fillStyle = '#155e75';
          ctx.font = '600 48px system-ui';
          ctx.fillText(
            astTime.toLocaleDateString('en-US',{ weekday:'long', month:'long', day:'numeric' }),
            textX, centerY - 28
          );
        
          ctx.fillStyle = '#64748b';
          ctx.font = 'italic 38px system-ui';
          ctx.fillText(
            `Inshore-Fajardo Bay, PR • ${astTime.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})} AST`,
            textX, centerY + 28
          );
        
          // Moon row
          if (moonIcon) ctx.drawImage(moonIcon, textX, centerY + 60, 60, 60);
          ctx.fillStyle = '#334155';
          ctx.font = '28px system-ui';
          ctx.fillText(
            `Moon Phase: ${moonPhase} • ${Math.round(moonIllum * 100)}%`,
            textX + 75, centerY + 90
          );
        
          // Columns
          const LEFT = 220;
          const RIGHT = 700;
          let y = 440;
        
          // Weather column
          ctx.fillStyle = '#1e40af';
          ctx.font = 'bold 46px system-ui';
          ctx.fillText('Weather', LEFT, y);
        
          y += 90;
          ctx.font = '900 70px system-ui';
          ctx.fillStyle = '#164e63';
          ctx.fillText(`${Math.round(cur.temperature_2m ?? 0)}°`, LEFT, y);
        
          y += 70;
          ctx.font = '30px system-ui';
          ctx.fillStyle = '#475569';
          ctx.fillText(`Feels ${Math.round(cur.apparent_temperature ?? 0)}°F`, LEFT, y);
        
          y += 46;
          ctx.fillStyle = '#1e293b';
          ctx.fillText(wmo(cur.weathercode), LEFT, y);
        
          y += 42;
          ctx.fillText(
            `Wind ${Math.round(cur.windspeed_10m ?? 0)} mph ${compass(cur.winddirection_10m ?? 0)}`,
            LEFT, y
          );
        
          // Marine column
          let my = 440;
          ctx.fillStyle = '#1e40af';
          ctx.font = 'bold 46px system-ui';
          ctx.fillText('Marine', RIGHT, my);
        
          my += 90;
          ctx.font = '700 70px system-ui';
          ctx.fillStyle = '#164e63';
          ctx.fillText(`${safeFixed((h.wave_height?.[12] ?? 0) * 3.28)} ft`, RIGHT, my);
        
          my += 70;
          ctx.font = '30px system-ui';
          ctx.fillStyle = '#475569';
          ctx.fillText(`Today • ${compass(h.wave_direction?.[12] || 0)}`, RIGHT, my);
        
          // Footer
          ctx.textAlign = 'center';
          ctx.font = 'italic 30px system-ui';
          ctx.fillStyle = '#64748b';
          ctx.fillText(
            'Powered by RabirubiaTech-API • Updated every 4 hours',
            540, 1035
          );
        }


            // EVERYTHING BELOW IS UNCHANGED FROM YOUR ORIGINAL FILE
            // (Weather column, marine column, header, footer, forecasts)

            // ... [intentionally unchanged]
          }

          run().catch(e=>{console.error(e);process.exit(1);});
          EOF

          node generate.cjs

      - name: Commit & Push
        run: |
          set -e
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add sunbay_marina_forecast.png
          git diff --staged --quiet || git commit -m "Fix current temperature source" && git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
