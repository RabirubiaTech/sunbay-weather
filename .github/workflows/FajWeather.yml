name: Update Sunbay Weather Card-New

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          npm install canvas node-fetch@2

      - name: Generate Weather Card
        run: |
          cat > generate.cjs << 'EOF'
          const { createCanvas, loadImage } = require('canvas');
          const fetch = require('node-fetch');
          const fs = require('fs');

          const W = 1080, H = 1080;
          const canvas = createCanvas(W, H);
          const ctx = canvas.getContext('2d');

          const BG_URL = "https://raw.githubusercontent.com/RabirubiaTech/sunbay-weather/main/Fajardo-Rabirubia.jpeg";
          const LOGO_URL = "https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png";
          const MOON_BASE = "https://raw.githubusercontent.com/manifestinteractive/moon-phase-icons/master/png/64/";

          const now = new Date();
          const ast = new Date(now.getTime() - 4 * 60 * 60 * 1000);

          const compass = d =>
            ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"]
            [Math.round(d / 22.5) % 16];

          const colorTemp = t => t >= 85 ? "#ef4444" : t >= 70 ? "#facc15" : "#38bdf8";
          const colorWind = w => w >= 20 ? "#ef4444" : w >= 12 ? "#facc15" : "#22c55e";
          const colorProb = p => p >= 60 ? "#ef4444" : p >= 30 ? "#facc15" : "#22c55e";
          const colorWave = h => h > 5 ? "#ef4444" : h >= 3 ? "#facc15" : "#22c55e";

          function moonPhaseFraction(date) {
            const syn = 29.53058867;
            const ref = Date.UTC(2000,0,6,18,14);
            const days = (date.getTime() - ref) / 86400000;
            const p = days / syn;
            return p - Math.floor(p);
          }

          function moonName(f) {
            const x = ((f % 1) + 1) % 1;
            if (x < 0.03) return "New Moon";
            if (x < 0.22) return "Waxing Crescent";
            if (x < 0.28) return "First Quarter";
            if (x < 0.47) return "Waxing Gibbous";
            if (x < 0.53) return "Full Moon";
            if (x < 0.72) return "Waning Gibbous";
            if (x < 0.78) return "Last Quarter";
            if (x < 0.97) return "Waning Crescent";
            return "New Moon";
          }

          async function safeImage(url) {
            try { return await loadImage(url); }
            catch { return null; }
          }

          async function run() {
            const w = await fetch(
              "https://api.open-meteo.com/v1/forecast" +
              "?latitude=18.3258&longitude=-65.6524" +
              "&current=temperature_2m,apparent_temperature,weathercode,windspeed_10m,winddirection_10m,rain" +
              "&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max,weathercode" +
              "&timezone=America/Puerto_Rico&temperature_unit=fahrenheit&wind_speed_unit=mph"
            ).then(r => r.json());

            const m = await fetch(
              "https://marine-api.open-meteo.com/v1/marine" +
              "?latitude=18.3258&longitude=-65.6524" +
              "&hourly=wave_height,wave_direction,wave_period" +
              "&daily=wave_height_max" +
              "&timezone=America/Puerto_Rico"
            ).then(r => r.json());

            const bg = await safeImage(BG_URL);
            const logo = await safeImage(LOGO_URL);

            const moonFrac = moonPhaseFraction(ast);
            const moonIndex = Math.floor(moonFrac * 28) % 28;
            const moonIcon = await safeImage(
              `${MOON_BASE}moon-phase-${String(moonIndex).padStart(2,'0')}.png`
            );

            draw(bg, logo, moonIcon, moonFrac, w, m);
            fs.writeFileSync("sunbay_marina_forecast1.png", canvas.toBuffer());
          }

          // -------------------------------------------------------
          // UPDATED DRAW FUNCTION WITH FIXED SPACING + ALIGNMENT
          // -------------------------------------------------------
          function draw(bg, logo, moonIcon, moonFrac, w, m) {
            if (bg) ctx.drawImage(bg, 0, 0, W, H);
            ctx.fillStyle = "rgba(0,0,0,0.55)";
            ctx.fillRect(0, 0, W, H);

            // Header
            if (logo) ctx.drawImage(logo, 60, 60, 150, 150);

            ctx.fillStyle = "#e5f9ff";
            ctx.textAlign = "left";

            ctx.font = "600 40px system-ui";
            ctx.fillText(
              ast.toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric"}),
              240, 115
            );

            ctx.font = "italic 28px system-ui";
            ctx.fillText(
              `Inshore Fajardo Bay â€¢ ${ast.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})} AST`,
              240, 160
            );

            // Moon
            if (moonIcon) ctx.drawImage(moonIcon, 240, 190, 50, 50);
            ctx.font = "26px system-ui";
            ctx.fillText(
              `Moon: ${moonName(moonFrac)} â€¢ ${Math.round(moonFrac * 200)}%`,
              300, 225
            );

            // Rain chance header (aligned with moon text)
            const prob = w.daily?.precipitation_probability_max?.[0] ?? 0;
            ctx.font = "italic 26px system-ui";
            ctx.fillStyle = colorProb(prob);
            ctx.fillText(
              `Rain chance today: ${prob}%`,
              300, 260
            );

            // WEATHER SECTION HEADER
            let y = 340;  // moved lower
            ctx.font = "700 32px system-ui";
            ctx.fillStyle = "#e5f9ff";
            ctx.fillText("Weather", 120, y);

            // WEATHER DATA BLOCK
            y += 80;  // extra padding
            const cur = w.current || {};

            ctx.font = "800 60px system-ui";
            ctx.fillStyle = colorTemp(cur.temperature_2m || 0);
            ctx.fillText(`ðŸŒ¡ï¸ ${Math.round(cur.temperature_2m)}Â°F`, 120, y);

            ctx.font = "30px system-ui";
            ctx.fillStyle = "#e5f9ff";
            ctx.fillText(`Feels like ${Math.round(cur.apparent_temperature)}Â°F`, 380, y);

            y += 55;
            ctx.fillStyle = colorWind(cur.windspeed_10m || 0);
            ctx.fillText(`â†” ${Math.round(cur.windspeed_10m)} mph ${compass(cur.winddirection_10m)}`, 120, y);

            y += 45;
            ctx.fillStyle = colorProb(prob);
            ctx.fillText(`Rain chance: ${prob}%`, 120, y);

            y += 45;
            ctx.fillStyle = "#e5f9ff";
            ctx.fillText(
              `Rainfall today: ${(w.daily?.precipitation_sum?.[0] || 0).toFixed(2)} in`,
              120, y
            );

            y += 45;
            ctx.fillText(
              `Tomorrow: ${Math.round(w.daily.temperature_2m_max[1])}Â° / ${Math.round(w.daily.temperature_2m_min[1])}Â°`,
              120, y
            );

            y += 45;
            ctx.fillText(
              `Day After: ${Math.round(w.daily.temperature_2m_max[2])}Â° / ${Math.round(w.daily.temperature_2m_min[2])}Â°`,
              120, y
            );

            // MARINE SECTION HEADER
            y += 90;  // extra padding
            ctx.font = "700 32px system-ui";
            ctx.fillStyle = "#e5f9ff";
            ctx.fillText("Marine", 120, y);

            // MARINE DATA BLOCK
            y += 80;  // extra padding
            const h = m.hourly || {};
            const waveFt = (h.wave_height?.[12] || 0) * 3.28;

            ctx.font = "700 60px system-ui";
            ctx.fillStyle = colorWave(waveFt);
            ctx.fillText(`ðŸŒŠ ${waveFt.toFixed(1)} ft`, 120, y);

            y += 50;
            ctx.font = "30px system-ui";
            ctx.fillStyle = "#e5f9ff";
            ctx.fillText(`Direction: ${compass(h.wave_direction?.[12] || 0)}`, 120, y);

            y += 40;
            ctx.fillText(`Period: ${h.wave_period?.[12] || 0} s`, 120, y);

            y += 50;
            ctx.fillText(
              `Tomorrow: ${(m.daily.wave_height_max[1] * 3.28).toFixed(1)} ft`,
              120, y
            );

            y += 40;
            ctx.fillText(
              `Day After: ${(m.daily.wave_height_max[2] * 3.28).toFixed(1)} ft`,
              120, y
            );

            // Footer
            ctx.textAlign = "center";
            ctx.font = "italic 26px system-ui";
            ctx.fillText(
              "Powered by RabirubiaTech â€¢ Updated every 4 hours",
              W / 2,
              H - 40
            );
          }

          run().catch(() => process.exit(0));
          EOF

          node generate.cjs

      - name: Commit & Push
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add sunbay_marina_forecast1.png
          git diff --staged --quiet || git commit -m "Updated full forecast weather card with spacing fixes"
          git push
